<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>vkTUNEos Dashboard | Music Kernel v1.0</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: #0a0a0f; color: #f8fafc; overflow-x: hidden; }
    .font-display { font-family: 'Space Grotesk', sans-serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    .mesh-bg {
      position: fixed; inset: 0; z-index: -1;
      background:
        radial-gradient(ellipse 80% 50% at 20% 40%, rgba(99,102,241,0.15), transparent),
        radial-gradient(ellipse 60% 40% at 80% 20%, rgba(236,72,153,0.1), transparent),
        radial-gradient(ellipse 50% 60% at 60% 80%, rgba(6,182,212,0.08), transparent),
        #0a0a0f;
    }
    .glass {
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .glass:hover { border-color: rgba(99,102,241,0.5); }
    .glow { box-shadow: 0 0 30px rgba(99,102,241,0.3); }
    @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes float { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-8px); } }
    .animate-fade { animation: fadeUp 0.6s ease-out forwards; }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-float { animation: float 4s ease-in-out infinite; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #12121a; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    .progress-bar { height: 6px; background: #1a1a25; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #ec4899); transition: width 0.5s ease; }
    .toast { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, createContext, useContext, useCallback } = React;

    // ========================================================================
    // API CONFIGURATION
    // ========================================================================

    // Use relative URLs - API and dashboard are served from same origin
    const API_BASE = '';

    // Current tenant ID (stored in state)
    let CURRENT_TENANT_ID = null;

    // ========================================================================
    // API FUNCTIONS
    // ========================================================================

    const api = {
      async fetch(endpoint, options = {}) {
        const headers = {
          'Content-Type': 'application/json',
          ...(CURRENT_TENANT_ID && { 'X-Tenant-ID': CURRENT_TENANT_ID }),
          ...options.headers
        };

        try {
          const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'API Error');
          return data;
        } catch (err) {
          console.error(`API Error [${endpoint}]:`, err);
          throw err;
        }
      },

      // Health
      async health() {
        return this.fetch('/health');
      },

      // Tenants
      async getTenants() {
        return this.fetch('/api/v1/tenants');
      },
      async createTenant(data) {
        return this.fetch('/api/v1/tenants', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      },

      // Coordinates
      async getCoordinates() {
        return this.fetch('/api/v1/coordinates');
      },
      async createCoordinate(data) {
        return this.fetch('/api/v1/coordinates', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      },
      async deleteCoordinate(id) {
        return this.fetch(`/api/v1/coordinates/${id}`, { method: 'DELETE' });
      },

      // Audit
      async getAuditLogs() {
        return this.fetch('/api/v1/audit');
      },

      // Workflows
      async getWorkflows() {
        return this.fetch('/api/v1/workflows');
      },
      async createWorkflow(type, data) {
        return this.fetch(`/api/v1/workflows/${type}`, {
          method: 'POST',
          body: JSON.stringify(data)
        });
      },

      // Usage
      async getUsage() {
        return this.fetch('/api/v1/usage');
      },

      // Schema
      async getSchema() {
        return this.fetch('/api/v1/schema');
      }
    };

    // ========================================================================
    // SEED DATA FUNCTION
    // ========================================================================

    async function seedDemoData(setToast) {
      try {
        setToast({ type: 'info', message: 'Seeding demo data...' });

        // Check if tenants exist
        const tenantsRes = await api.getTenants();
        if (tenantsRes.data && tenantsRes.data.length > 0) {
          CURRENT_TENANT_ID = tenantsRes.data[0].id;
          setToast({ type: 'success', message: 'Data loaded!' });
          return tenantsRes.data[0];
        }

        // Create demo tenant
        const tenant = await api.createTenant({
          name: 'Demo Music Studio',
          slug: 'demo-studio',
          tier: 'premium',
          contact_email: 'demo@vktuneos.com'
        });

        CURRENT_TENANT_ID = tenant.data.id;

        // Create sample coordinates
        const coords = [
          { L1_category: 'VoiceCloning', L2_domain: 'Tool', L3_entity: 'ElevenLabs', L4_attribute: 'Languages', L5_state: 'Validated', metadata: { languages: ['en', 'es', 'fr'] } },
          { L1_category: 'StemSeparation', L2_domain: 'Model', L3_entity: 'Phoenix', L4_attribute: 'Fidelity', L5_state: 'Validated', value: 9.2 },
          { L1_category: 'MusicGeneration', L2_domain: 'Tool', L3_entity: 'Suno', L4_attribute: 'Pricing', L5_state: 'Proposed', metadata: { pricing_model: 'subscription' } },
          { L1_category: 'VoiceCloning', L2_domain: 'Model', L3_entity: 'KitsAI', L4_attribute: 'Fidelity', L5_state: 'Draft', value: 8.5, metadata: { source_consent: true, neural_network_model: 'kits-v2' } },
          { L1_category: 'AudioProduction', L2_domain: 'Tool', L3_entity: 'LANDR', L4_attribute: 'Pricing', L5_state: 'Validated', metadata: { pricing_model: 'subscription', billing_period: 'monthly' } },
        ];

        for (const coord of coords) {
          try {
            await api.createCoordinate(coord);
          } catch (e) {
            console.log('Coord may exist:', e.message);
          }
        }

        setToast({ type: 'success', message: 'Demo data seeded!' });
        return tenant.data;
      } catch (err) {
        console.error('Seed error:', err);
        setToast({ type: 'error', message: 'Seed failed: ' + err.message });
        return null;
      }
    }

    // ========================================================================
    // ICONS
    // ========================================================================

    const Icons = {
      Home: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
      Music: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>,
      Mic: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>,
      Layers: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
      Workflow: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>,
      Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
      Chart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
      Shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
      Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
      Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
      Database: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>,
      Zap: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
      Clock: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      Refresh: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
    };

    // ========================================================================
    // COMPONENTS
    // ========================================================================

    // Toast Notification
    const Toast = ({ toast, onClose }) => {
      if (!toast) return null;
      const colors = {
        success: 'bg-emerald-500/20 border-emerald-500 text-emerald-400',
        error: 'bg-red-500/20 border-red-500 text-red-400',
        info: 'bg-indigo-500/20 border-indigo-500 text-indigo-400'
      };
      return (
        <div className={`toast glass ${colors[toast.type]} border px-4 py-3 rounded-xl flex items-center gap-3 animate-fade`}>
          {toast.type === 'success' && <Icons.Check />}
          {toast.type === 'error' && <Icons.X />}
          {toast.type === 'info' && <div className="w-5 h-5 border-2 border-current border-t-transparent rounded-full animate-spin" />}
          <span>{toast.message}</span>
          <button onClick={onClose} className="ml-2 hover:opacity-70"><Icons.X /></button>
        </div>
      );
    };

    // Loading Spinner
    const Spinner = () => (
      <div className="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin" />
    );

    // Status Badge
    const StatusBadge = ({ status }) => {
      const colors = {
        Validated: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
        Proposed: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
        Draft: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
        Deprecated: 'bg-red-500/20 text-red-400 border-red-500/30',
        completed: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
        running: 'bg-indigo-500/20 text-indigo-400 border-indigo-500/30',
        pending: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
        failed: 'bg-red-500/20 text-red-400 border-red-500/30',
        free: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
        premium: 'bg-indigo-500/20 text-indigo-400 border-indigo-500/30',
        enterprise: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
      };
      return (
        <span className={`px-2.5 py-1 text-xs font-medium rounded-full border ${colors[status] || colors.Draft}`}>
          {status}
        </span>
      );
    };

    // Stat Card
    const StatCard = ({ title, value, icon: Icon, loading }) => (
      <div className="glass rounded-2xl p-5 hover:glow transition-all duration-300">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-slate-400 text-sm mb-1">{title}</p>
            {loading ? <Spinner /> : <p className="text-3xl font-display font-bold">{value}</p>}
          </div>
          <div className="p-3 rounded-xl bg-indigo-500/10 text-indigo-400">
            <Icon />
          </div>
        </div>
      </div>
    );

    // Sidebar
    const Sidebar = ({ currentPage, setCurrentPage, collapsed, setCollapsed }) => {
      const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: Icons.Home },
        { id: 'coordinates', label: 'Coordinates', icon: Icons.Database },
        { id: 'workflows', label: 'Workflows', icon: Icons.Workflow },
        { id: 'tenants', label: 'Tenants', icon: Icons.Users },
        { id: 'audit', label: 'Audit Log', icon: Icons.Shield },
        { id: 'usage', label: 'Usage', icon: Icons.Chart },
      ];

      return (
        <aside className={`fixed left-0 top-0 h-full glass border-r border-white/5 transition-all duration-300 z-50 ${collapsed ? 'w-20' : 'w-64'}`}>
          <div className="p-5 border-b border-white/5">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-display font-bold text-lg animate-float">
                vK
              </div>
              {!collapsed && <span className="font-display font-bold text-xl">TUNEos</span>}
            </div>
          </div>
          <nav className="p-3 space-y-1">
            {navItems.map((item) => (
              <button
                key={item.id}
                onClick={() => setCurrentPage(item.id)}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
                  currentPage === item.id
                    ? 'bg-indigo-500/20 text-indigo-400 glow'
                    : 'text-slate-400 hover:text-white hover:bg-white/5'
                }`}
              >
                <item.icon />
                {!collapsed && <span className="font-medium">{item.label}</span>}
              </button>
            ))}
          </nav>
          <button
            onClick={() => setCollapsed(!collapsed)}
            className="absolute bottom-5 left-1/2 -translate-x-1/2 p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
          >
            <svg className={`w-5 h-5 transition-transform ${collapsed ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
            </svg>
          </button>
        </aside>
      );
    };

    // Header
    const Header = ({ title, onRefresh, loading, tenants }) => {
      const activeTenant = tenants?.find(t => t.id === CURRENT_TENANT_ID);
      return (
        <header className="glass rounded-2xl p-4 mb-6 flex items-center justify-between animate-fade">
          <h1 className="text-2xl font-display font-bold">{title}</h1>
          <div className="flex items-center gap-4">
            <button
              onClick={onRefresh}
              disabled={loading}
              className="p-2 rounded-xl bg-white/5 hover:bg-white/10 transition-colors disabled:opacity-50"
            >
              <Icons.Refresh className={loading ? 'animate-spin' : ''} />
            </button>
            {activeTenant ? (
              <div className="text-sm flex items-center gap-2">
                <span className="text-slate-400">Tenant:</span>
                <span className="text-white font-medium">{activeTenant.name}</span>
                <span className={`px-2 py-0.5 rounded text-xs ${activeTenant.tier === 'free' ? 'bg-slate-600' : activeTenant.tier === 'premium' ? 'bg-indigo-600' : 'bg-amber-600'}`}>
                  {activeTenant.tier}
                </span>
              </div>
            ) : (
              <div className="text-sm text-slate-400">No tenant selected</div>
            )}
          </div>
        </header>
      );
    };

    // Modal
    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="glass rounded-2xl p-6 max-w-lg w-full animate-fade">
            <div className="flex items-center justify-between mb-4">
              <h2 className="font-display font-semibold text-xl">{title}</h2>
              <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-lg"><Icons.X /></button>
            </div>
            {children}
          </div>
        </div>
      );
    };

    // ========================================================================
    // PAGES
    // ========================================================================

    // Dashboard Page
    const DashboardPage = ({ data, loading, setToast, onRefresh }) => {
      const [testLoading, setTestLoading] = useState(null);

      const createTestTenant = async (tier) => {
        setTestLoading(tier);
        try {
          const slug = `test-${tier}-${Date.now()}`;
          const result = await api.createTenant({
            name: `Test ${tier.charAt(0).toUpperCase() + tier.slice(1)} Tenant`,
            slug: slug,
            tier: tier,
            contact_email: `test-${tier}@vktuneos.com`
          });
          CURRENT_TENANT_ID = result.data.id;
          setToast({ type: 'success', message: `Created & switched to ${tier} tenant!` });
          if (onRefresh) onRefresh();
        } catch (err) {
          setToast({ type: 'error', message: err.message });
        }
        setTestLoading(null);
      };

      const tierColors = {
        free: 'from-slate-500 to-slate-600',
        premium: 'from-indigo-500 to-purple-600',
        enterprise: 'from-amber-500 to-orange-600'
      };

      const tierFeatures = {
        free: ['100 API calls/day', '1 voice clone', '2-stem separation', '2 min music'],
        premium: ['5,000 API calls/day', '10 voice clones', '10-stem separation', '30 min music', 'Workflows'],
        enterprise: ['Unlimited API calls', 'Unlimited clones', '10-stem separation', 'Unlimited music', 'All features']
      };

      return (
        <div className="space-y-6">
          {/* Tier Test Buttons */}
          <div className="glass rounded-2xl p-5">
            <h2 className="font-display font-semibold text-lg mb-4">Test Authority Levels</h2>
            <p className="text-slate-400 text-sm mb-4">Create a test tenant with different permission tiers to test features:</p>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {['free', 'premium', 'enterprise'].map((tier) => (
                <div key={tier} className={`rounded-xl p-4 bg-gradient-to-br ${tierColors[tier]} bg-opacity-20`}>
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="font-display font-bold text-lg capitalize">{tier}</h3>
                    <span className={`px-2 py-1 rounded-lg text-xs font-medium ${tier === 'free' ? 'bg-slate-700' : tier === 'premium' ? 'bg-indigo-600' : 'bg-amber-600'}`}>
                      {tier === 'free' ? 'L1' : tier === 'premium' ? 'L2' : 'L3'}
                    </span>
                  </div>
                  <ul className="text-xs text-white/80 space-y-1 mb-4">
                    {tierFeatures[tier].map((feat, i) => (
                      <li key={i} className="flex items-center gap-2">
                        <Icons.Check className="w-3 h-3 text-emerald-400" /> {feat}
                      </li>
                    ))}
                  </ul>
                  <button
                    onClick={() => createTestTenant(tier)}
                    disabled={testLoading === tier}
                    className={`w-full py-2 rounded-lg font-medium text-sm transition-all ${testLoading === tier ? 'opacity-50 cursor-wait' : 'hover:opacity-90'} bg-white/20`}
                  >
                    {testLoading === tier ? 'Creating...' : `Create ${tier.charAt(0).toUpperCase() + tier.slice(1)} Tenant`}
                  </button>
                </div>
              ))}
            </div>
            {CURRENT_TENANT_ID && (
              <div className="mt-4 p-3 rounded-xl bg-emerald-500/20 border border-emerald-500/30">
                <p className="text-sm text-emerald-400">
                  <strong>Active Tenant:</strong> <span className="font-mono">{CURRENT_TENANT_ID}</span>
                </p>
              </div>
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <StatCard title="Tenants" value={data.tenants?.length || 0} icon={Icons.Users} loading={loading} />
            <StatCard title="Coordinates" value={data.coordinates?.length || 0} icon={Icons.Database} loading={loading} />
            <StatCard title="Workflows" value={data.workflows?.length || 0} icon={Icons.Workflow} loading={loading} />
            <StatCard title="Audit Events" value={data.audit?.length || 0} icon={Icons.Shield} loading={loading} />
          </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="glass rounded-2xl p-5">
            <h2 className="font-display font-semibold text-lg mb-4">Recent Coordinates</h2>
            {loading ? <Spinner /> : (
              <div className="space-y-3">
                {(data.coordinates || []).slice(0, 5).map((coord) => (
                  <div key={coord.id} className="flex items-center justify-between p-3 rounded-xl bg-white/5">
                    <div>
                      <p className="font-mono text-sm">{coord.L1_category}.{coord.L2_domain}.{coord.L3_entity}</p>
                      <p className="text-xs text-slate-500">{coord.L4_attribute}</p>
                    </div>
                    <StatusBadge status={coord.L5_state} />
                  </div>
                ))}
                {(!data.coordinates || data.coordinates.length === 0) && (
                  <p className="text-slate-500 text-sm">No coordinates yet</p>
                )}
              </div>
            )}
          </div>

          <div className="glass rounded-2xl p-5">
            <h2 className="font-display font-semibold text-lg mb-4">Recent Activity</h2>
            {loading ? <Spinner /> : (
              <div className="space-y-3">
                {(data.audit || []).slice(0, 5).map((event) => (
                  <div key={event.id} className="flex items-center gap-3 p-3 rounded-xl bg-white/5">
                    <div className="w-2 h-2 rounded-full bg-indigo-500" />
                    <div>
                      <p className="text-sm">{event.action} - {event.resource_type}</p>
                      <p className="text-xs text-slate-500">{new Date(event.created_at).toLocaleString()}</p>
                    </div>
                  </div>
                ))}
                {(!data.audit || data.audit.length === 0) && (
                  <p className="text-slate-500 text-sm">No activity yet</p>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
      );
    };

    // Coordinates Page
    const CoordinatesPage = ({ data, loading, onRefresh, setToast }) => {
      const [showModal, setShowModal] = useState(false);
      const [form, setForm] = useState({
        L1_category: 'VoiceCloning',
        L2_domain: 'Tool',
        L3_entity: 'NewEntity',
        L4_attribute: 'Fidelity',
        L5_state: 'Draft'
      });

      const handleCreate = async () => {
        try {
          setToast({ type: 'info', message: 'Creating coordinate...' });
          await api.createCoordinate(form);
          setToast({ type: 'success', message: 'Coordinate created!' });
          setShowModal(false);
          onRefresh();
        } catch (err) {
          setToast({ type: 'error', message: err.message });
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Delete this coordinate?')) return;
        try {
          await api.deleteCoordinate(id);
          setToast({ type: 'success', message: 'Coordinate deleted!' });
          onRefresh();
        } catch (err) {
          setToast({ type: 'error', message: err.message });
        }
      };

      return (
        <div className="space-y-6">
          <div className="glass rounded-2xl p-5">
            <div className="flex items-center justify-between mb-6">
              <h2 className="font-display font-semibold text-lg">All Coordinates</h2>
              <button
                onClick={() => setShowModal(true)}
                className="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-sm font-medium transition-colors flex items-center gap-2"
              >
                <Icons.Plus /> Create Coordinate
              </button>
            </div>
            {loading ? <Spinner /> : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-left text-slate-400 text-sm border-b border-white/5">
                      <th className="pb-3 font-medium">Coordinate Path</th>
                      <th className="pb-3 font-medium">Category</th>
                      <th className="pb-3 font-medium">State</th>
                      <th className="pb-3 font-medium">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(data.coordinates || []).map((coord) => (
                      <tr key={coord.id} className="border-b border-white/5 hover:bg-white/5">
                        <td className="py-4 font-mono text-sm">{coord.L1_category}.{coord.L2_domain}.{coord.L3_entity}.{coord.L4_attribute}</td>
                        <td className="py-4"><span className="px-2 py-1 bg-indigo-500/10 text-indigo-400 rounded-lg text-xs">{coord.L1_category}</span></td>
                        <td className="py-4"><StatusBadge status={coord.L5_state} /></td>
                        <td className="py-4">
                          <button
                            onClick={() => handleDelete(coord.id)}
                            className="p-1.5 rounded-lg hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition-colors"
                          >
                            <Icons.X />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {(!data.coordinates || data.coordinates.length === 0) && (
                  <p className="text-slate-500 text-sm text-center py-8">No coordinates. Create one!</p>
                )}
              </div>
            )}
          </div>

          <Modal isOpen={showModal} onClose={() => setShowModal(false)} title="Create Coordinate">
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-slate-400 mb-2">Category (L1)</label>
                <select
                  value={form.L1_category}
                  onChange={(e) => setForm({...form, L1_category: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3"
                >
                  <option>VoiceCloning</option>
                  <option>StemSeparation</option>
                  <option>MusicGeneration</option>
                  <option>AudioProduction</option>
                  <option>Licensing</option>
                </select>
              </div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Domain (L2)</label>
                <select
                  value={form.L2_domain}
                  onChange={(e) => setForm({...form, L2_domain: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3"
                >
                  <option>Tool</option>
                  <option>Model</option>
                  <option>Quality</option>
                  <option>Rights</option>
                  <option>Usage</option>
                </select>
              </div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Entity (L3)</label>
                <input
                  type="text"
                  value={form.L3_entity}
                  onChange={(e) => setForm({...form, L3_entity: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3"
                  placeholder="EntityName (PascalCase)"
                />
              </div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Attribute (L4)</label>
                <select
                  value={form.L4_attribute}
                  onChange={(e) => setForm({...form, L4_attribute: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3"
                >
                  <option>Fidelity</option>
                  <option>Latency</option>
                  <option>Languages</option>
                  <option>Pricing</option>
                  <option>Formats</option>
                  <option>API</option>
                </select>
              </div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">State (L5)</label>
                <select
                  value={form.L5_state}
                  onChange={(e) => setForm({...form, L5_state: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3"
                >
                  <option>Draft</option>
                  <option>Proposed</option>
                  <option>Validated</option>
                  <option>Deprecated</option>
                </select>
              </div>
              <button
                onClick={handleCreate}
                className="w-full py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl font-medium transition-colors"
              >
                Create Coordinate
              </button>
            </div>
          </Modal>
        </div>
      );
    };

    // Workflows Page
    const WorkflowsPage = ({ data, loading, onRefresh, setToast }) => {
      const [showModal, setShowModal] = useState(false);
      const [workflowType, setWorkflowType] = useState('text-to-music');
      const [prompt, setPrompt] = useState('Create an upbeat electronic track');

      const handleRunWorkflow = async () => {
        try {
          setToast({ type: 'info', message: 'Starting workflow...' });
          await api.createWorkflow(workflowType, { prompt, duration_seconds: 60 });
          setToast({ type: 'success', message: 'Workflow started!' });
          setShowModal(false);
          onRefresh();
        } catch (err) {
          setToast({ type: 'error', message: err.message });
        }
      };

      const workflowTypes = [
        { type: 'text-to-music', title: 'Text to Music', desc: 'Generate music from a text prompt', icon: Icons.Music },
        { type: 'lyrics-to-song', title: 'Lyrics to Song', desc: 'Create songs with voice cloning', icon: Icons.Mic },
        { type: 'remix', title: 'Remix', desc: 'Separate stems and remix', icon: Icons.Layers },
      ];

      return (
        <div className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {workflowTypes.map((wf) => (
              <div
                key={wf.type}
                onClick={() => { setWorkflowType(wf.type); setShowModal(true); }}
                className="glass rounded-2xl p-5 hover:glow cursor-pointer transition-all"
              >
                <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mb-4">
                  <wf.icon />
                </div>
                <h3 className="font-display font-semibold text-lg mb-2">{wf.title}</h3>
                <p className="text-slate-400 text-sm">{wf.desc}</p>
              </div>
            ))}
          </div>

          <div className="glass rounded-2xl p-5">
            <h2 className="font-display font-semibold text-lg mb-4">Recent Workflows</h2>
            {loading ? <Spinner /> : (
              <div className="space-y-3">
                {(data.workflows || []).map((wf) => (
                  <div key={wf.id} className="flex items-center justify-between p-4 rounded-xl bg-white/5">
                    <div className="flex items-center gap-4">
                      <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${wf.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-indigo-500/20 text-indigo-400'}`}>
                        {wf.status === 'running' ? <Spinner /> : <Icons.Check />}
                      </div>
                      <div>
                        <p className="font-medium">{wf.type}</p>
                        <p className="text-xs text-slate-500">{wf.id}</p>
                      </div>
                    </div>
                    <StatusBadge status={wf.status} />
                  </div>
                ))}
                {(!data.workflows || data.workflows.length === 0) && (
                  <p className="text-slate-500 text-sm text-center py-4">No workflows yet. Start one above!</p>
                )}
              </div>
            )}
          </div>

          <Modal isOpen={showModal} onClose={() => setShowModal(false)} title={`Run ${workflowType}`}>
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-slate-400 mb-2">Prompt</label>
                <textarea
                  value={prompt}
                  onChange={(e) => setPrompt(e.target.value)}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 h-24"
                  placeholder="Describe what you want..."
                />
              </div>
              <button
                onClick={handleRunWorkflow}
                className="w-full py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl font-medium transition-colors"
              >
                Start Workflow
              </button>
            </div>
          </Modal>
        </div>
      );
    };

    // Tenants Page
    const TenantsPage = ({ data, loading, onRefresh, setToast }) => {
      const [showModal, setShowModal] = useState(false);
      const [form, setForm] = useState({ name: '', slug: '', tier: 'free', contact_email: '' });

      const handleCreate = async () => {
        try {
          setToast({ type: 'info', message: 'Creating tenant...' });
          const result = await api.createTenant(form);
          CURRENT_TENANT_ID = result.data.id;
          setToast({ type: 'success', message: 'Tenant created!' });
          setShowModal(false);
          onRefresh();
        } catch (err) {
          setToast({ type: 'error', message: err.message });
        }
      };

      return (
        <div className="space-y-6">
          <div className="glass rounded-2xl p-5">
            <div className="flex items-center justify-between mb-6">
              <h2 className="font-display font-semibold text-lg">All Tenants</h2>
              <button
                onClick={() => setShowModal(true)}
                className="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-sm font-medium transition-colors flex items-center gap-2"
              >
                <Icons.Plus /> Add Tenant
              </button>
            </div>
            {loading ? <Spinner /> : (
              <div className="space-y-3">
                {(data.tenants || []).map((t) => (
                  <div
                    key={t.id}
                    onClick={() => { CURRENT_TENANT_ID = t.id; setToast({ type: 'success', message: `Switched to ${t.name}` }); }}
                    className={`flex items-center justify-between p-4 rounded-xl cursor-pointer transition-colors ${CURRENT_TENANT_ID === t.id ? 'bg-indigo-500/20 border border-indigo-500/50' : 'bg-white/5 hover:bg-white/10'}`}
                  >
                    <div className="flex items-center gap-4">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-display font-bold">
                        {t.name.charAt(0)}
                      </div>
                      <div>
                        <p className="font-medium">{t.name}</p>
                        <p className="text-xs text-slate-500 font-mono">{t.id}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-4">
                      <StatusBadge status={t.tier} />
                      {CURRENT_TENANT_ID === t.id && <span className="text-xs text-indigo-400">Active</span>}
                    </div>
                  </div>
                ))}
                {(!data.tenants || data.tenants.length === 0) && (
                  <p className="text-slate-500 text-sm text-center py-4">No tenants yet. Create one!</p>
                )}
              </div>
            )}
          </div>

          <Modal isOpen={showModal} onClose={() => setShowModal(false)} title="Create Tenant">
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-slate-400 mb-2">Name</label>
                <input
                  type="text"
                  value={form.name}
                  onChange={(e) => setForm({...form, name: e.target.value, slug: e.target.value.toLowerCase().replace(/\s+/g, '-')})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3"
                  placeholder="My Music Studio"
                />
              </div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Slug</label>
                <input
                  type="text"
                  value={form.slug}
                  onChange={(e) => setForm({...form, slug: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 font-mono"
                  placeholder="my-music-studio"
                />
              </div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Tier</label>
                <select
                  value={form.tier}
                  onChange={(e) => setForm({...form, tier: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3"
                >
                  <option value="free">Free</option>
                  <option value="premium">Premium</option>
                  <option value="enterprise">Enterprise</option>
                </select>
              </div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Contact Email</label>
                <input
                  type="email"
                  value={form.contact_email}
                  onChange={(e) => setForm({...form, contact_email: e.target.value})}
                  className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3"
                  placeholder="admin@example.com"
                />
              </div>
              <button
                onClick={handleCreate}
                className="w-full py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl font-medium transition-colors"
              >
                Create Tenant
              </button>
            </div>
          </Modal>
        </div>
      );
    };

    // Audit Page
    const AuditPage = ({ data, loading }) => (
      <div className="space-y-6">
        <div className="glass rounded-2xl p-5">
          <h2 className="font-display font-semibold text-lg mb-4">Audit Log</h2>
          {loading ? <Spinner /> : (
            <div className="space-y-2">
              {(data.audit || []).map((e) => (
                <div key={e.id} className="flex items-center justify-between p-3 rounded-xl hover:bg-white/5 transition-colors">
                  <div className="flex items-center gap-4">
                    <div className="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                      <Icons.Shield />
                    </div>
                    <div>
                      <p className="font-mono text-sm">{e.action} - {e.resource_type}</p>
                      <p className="text-xs text-slate-500">{e.user_id || 'system'}</p>
                    </div>
                  </div>
                  <span className="text-sm text-slate-400">{new Date(e.created_at).toLocaleString()}</span>
                </div>
              ))}
              {(!data.audit || data.audit.length === 0) && (
                <p className="text-slate-500 text-sm text-center py-8">No audit events yet</p>
              )}
            </div>
          )}
        </div>
      </div>
    );

    // Usage Page
    const UsagePage = ({ data, loading }) => (
      <div className="space-y-6">
        <div className="glass rounded-2xl p-5">
          <h2 className="font-display font-semibold text-lg mb-4">Usage Statistics</h2>
          {loading ? <Spinner /> : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {(data.usage?.resources || []).map((r) => (
                <div key={r.resource_type} className="p-4 rounded-xl bg-white/5">
                  <p className="text-slate-400 text-sm mb-2">{r.resource_type}</p>
                  <p className="text-2xl font-display font-bold">{r.count}</p>
                  <p className="text-xs text-slate-500">Period: {r.period}</p>
                </div>
              ))}
              {(!data.usage?.resources || data.usage.resources.length === 0) && (
                <p className="text-slate-500 text-sm">No usage data yet</p>
              )}
            </div>
          )}
        </div>
      </div>
    );

    // ========================================================================
    // MAIN APP
    // ========================================================================

    const App = () => {
      const [currentPage, setCurrentPage] = useState('dashboard');
      const [collapsed, setCollapsed] = useState(false);
      const [loading, setLoading] = useState(true);
      const [toast, setToast] = useState(null);
      const [data, setData] = useState({
        tenants: [],
        coordinates: [],
        workflows: [],
        audit: [],
        usage: null
      });

      const fetchAllData = useCallback(async () => {
        setLoading(true);
        try {
          // Check health first
          await api.health();

          // Get tenants first
          const tenantsRes = await api.getTenants().catch(() => ({ data: [] }));
          const tenants = tenantsRes.data || [];

          // If no tenant selected but tenants exist, select the first one
          if (!CURRENT_TENANT_ID && tenants.length > 0) {
            CURRENT_TENANT_ID = tenants[0].id;
          }

          // If still no tenant, seed demo data
          if (!CURRENT_TENANT_ID && tenants.length === 0) {
            const seeded = await seedDemoData(setToast);
            if (seeded) {
              const updatedTenants = await api.getTenants().catch(() => ({ data: [] }));
              tenants.push(...(updatedTenants.data || []));
            }
          }

          // Only fetch tenant-scoped data if we have a tenant
          let coordsRes = { data: [] };
          let auditRes = { data: [] };

          if (CURRENT_TENANT_ID) {
            [coordsRes, auditRes] = await Promise.all([
              api.getCoordinates().catch(() => ({ data: [] })),
              api.getAuditLogs().catch(() => ({ data: [] })),
            ]);
          }

          setData({
            tenants: tenants,
            coordinates: coordsRes.data || [],
            workflows: [],
            audit: auditRes.data || [],
            usage: null
          });
        } catch (err) {
          console.error('fetchAllData error:', err);
          setToast({ type: 'error', message: 'Failed to load data: ' + err.message });
        }
        setLoading(false);
      }, []);

      useEffect(() => {
        fetchAllData();
      }, [fetchAllData]);

      useEffect(() => {
        if (toast) {
          const timer = setTimeout(() => setToast(null), 5000);
          return () => clearTimeout(timer);
        }
      }, [toast]);

      const pages = {
        dashboard: () => <DashboardPage data={data} loading={loading} setToast={setToast} onRefresh={fetchAllData} />,
        coordinates: () => <CoordinatesPage data={data} loading={loading} onRefresh={fetchAllData} setToast={setToast} />,
        workflows: () => <WorkflowsPage data={data} loading={loading} onRefresh={fetchAllData} setToast={setToast} />,
        tenants: () => <TenantsPage data={data} loading={loading} onRefresh={fetchAllData} setToast={setToast} />,
        audit: () => <AuditPage data={data} loading={loading} />,
        usage: () => <UsagePage data={data} loading={loading} />,
      };

      const CurrentPageComponent = pages[currentPage] || pages.dashboard;
      const pageTitles = {
        dashboard: 'Dashboard',
        coordinates: 'Coordinates',
        workflows: 'Workflows',
        tenants: 'Tenants',
        audit: 'Audit Log',
        usage: 'Usage'
      };

      return (
        <>
          <div className="mesh-bg" />
          <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} collapsed={collapsed} setCollapsed={setCollapsed} />
          <main className={`transition-all duration-300 ${collapsed ? 'ml-20' : 'ml-64'} p-6 min-h-screen`}>
            <Header title={pageTitles[currentPage]} onRefresh={fetchAllData} loading={loading} tenants={data.tenants} />
            <CurrentPageComponent />
          </main>
          <Toast toast={toast} onClose={() => setToast(null)} />
        </>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
